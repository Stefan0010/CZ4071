<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Client</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>

<input id="input_file" type="text" />
<button id="load_graph">Load graph</button>
<button id="gen_scale_free">Gen. scale-free network</button>
<button id="get_properties">Get properties</button>
<button id="plot_graph">Plot graph</button>
<img src="" id="plot_loader" width="1366" height="768" />

</body>

<script type="text/javascript">
///////////////////////////////////////////////////
var protocol = 'ws'
var host = 'localhost'
var port = 8888
var ws = new WebSocket(protocol + '://' + host + ':' + port)

window.addEventListener('beforeunload', function (event) {
    if(ws.readyState != ws.CLOSED)
        ws.close(1000, 'Client disconnected')
})

var current_status = {
    'CONNECTED': false,
    'WAIT': false,
    'PREV_CMD': null,
}

///////////////////////////////////////////////////
var input_file = document.getElementById('input_file')
input_file.value = 'L:/roadNet-CA.txt'

var load_graph = document.getElementById('load_graph')
var gen_scale_free = document.getElementById('gen_scale_free')
var get_properties = document.getElementById('get_properties')
var plot_graph = document.getElementById('plot_graph')
var im_paths = []
var show_idx = 0

///////////////////////////////////////////////////
function wait() {
    current_status['WAIT'] = true

    input_file.disabled = true
    load_graph.disabled = true
    get_properties.disabled = true
    gen_scale_free.disabled = true
    plot_graph.disabled = true
}

function unwait() {
    current_status['WAIT'] = false

    input_file.disabled = false
    load_graph.disabled = false
    get_properties.disabled = false
    gen_scale_free.disabled = false
    plot_graph.disabled = false
}

document.addEventListener('keypress', function (event) {
    if(event.keyCode == 39) {
        show_idx = (show_idx + 1) % im_paths.length;
        plot_loader.src = 'file:///' + im_paths[show_idx]
    }
    else if(event.keyCode == 37) {
        show_idx = (show_idx + im_paths.length - 1) % im_paths.length
        plot_loader.src = 'file:///' + im_paths[show_idx]
    }
})

function plot() {
    plot_loader.src = 'file:///' + im_paths[show_idx]
}

function parse_return(value) {
    switch(current_status['PREV_CMD']) {
        case 'LOAD_GRAPH':
            show_idx = 0
            im_paths = []
            alert('Graph is loaded!')
            break
        case 'GET_PROPERTIES':
            im_paths = im_paths.concat(value)
            plot()
            break
        case 'GEN_SCALE_FREE':
            alert('Scale free graph is loaded!')
            break
        case 'PLOT_GRAPH':
            alert('Graph is successfully plotted!')
            im_paths = im_paths.concat(value)
            plot()
        default:
            break
    }
}

///////////////////////////////////////////////////

load_graph.addEventListener('click', function (event) {
    if(!current_status['CONNECTED'])
        return

    if(current_status['WAIT']) {
        alert('Please wait for previous command to finish!')
        return
    }

    ws.send(JSON.stringify({
        'cmd': 'LOAD_GRAPH',
        'args': [input_file.value],
    }))

    wait()
    current_status['PREV_CMD'] = 'LOAD_GRAPH'
})

get_properties.addEventListener('click', function (event) {
    if(!current_status['CONNECTED'])
        return

    if(current_status['WAIT']) {
        alert('Please wait for previous command to finish!')
        return
    }

    ws.send(JSON.stringify({
        'cmd': 'GET_PROPERTIES',
        'args': []
    }))

    wait()
    current_status['PREV_CMD'] = 'GET_PROPERTIES'
})

gen_scale_free.addEventListener('click', function (event) {
    if(!current_status['CONNECTED'])
        return

    if(current_status['WAIT']) {
        alert('Please wait for previous command to finish!')
        return
    }

    ws.send(JSON.stringify({
        'cmd': 'GEN_SCALE_FREE',
        'args': []
    }))

    wait()
    current_status['PREV_CMD'] = 'GEN_SCALE_FREE'
})

plot_graph.addEventListener('click', function (event) {
    if(!current_status['CONNECTED'])
        return

    if(current_status['WAIT']) {
        alert('Please wait for previous command to finish!')
        return
    }

    ws.send(JSON.stringify({
        'cmd': 'PLOT_GRAPH',
        'args': []
    }))

    wait()
    current_status['PREV_CMD'] = 'PLOT_GRAPH'
})

ws.onopen = function (event) {
    current_status['CONNECTED'] = true
}

ws.onmessage = function (event) {
    var data = JSON.parse(event.data)

    unwait()
    switch(data['type']) {
        case 'RETURN':
            parse_return(data['value'])
            break

        case 'ERROR':
            alert(data['value'])
            break

        default:
            break
    }
}

ws.onclose = function (event) {
    // Do nothing
}

ws.onerror = function (event) {
    alert('An error has occurred. It is advised to reload the page.')
}
</script>

</html>